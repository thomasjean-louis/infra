Resources:
  AlbCertificate:
    Type: "AWS::CertificateManager::Certificate"
    Properties:
      DomainName: !Join
        - .
        - - !Ref RandomString
          - !Ref HostedZoneName
      DomainValidationOptions:
        - DomainName: !Join
            - .
            - - !Ref RandomString
              - !Ref HostedZoneName
          HostedZoneId: !Ref HostedZoneId
      ValidationMethod: DNS
      Tags:
        - Key: Name
          Value: !Sub Certificate-${RandomString}

  Alb:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub Alb-${RandomString}
      Type: application
      Scheme: internet-facing
      Subnets:
        - !Ref PublicSubnetIdA
        - !Ref PublicSubnetIdB
      SecurityGroups:
        - !Ref SecurityGroupAlbId
      Tags:
        - Key: Name
          Value: !Sub Alb-${RandomString}

  HttpsTargetGroup:
    Type: "AWS::ElasticLoadBalancingV2::TargetGroup"
    Properties:
      Port: 443
      Protocol: HTTPS
      TargetType: ip
      Matcher:
        HttpCode: 404
      VpcId: !Ref VpcId
      Tags:
        - Key: Name
          Value: !Sub TargetGroup-HTTPS-${RandomString}

  WsTargetGroup:
    Type: "AWS::ElasticLoadBalancingV2::TargetGroup"
    Properties:
      Port: !Ref ProxyServerPort
      Protocol: HTTPS
      Matcher:
        HttpCode: 404
      TargetType: ip
      VpcId: !Ref VpcId
      Tags:
        - Key: Name
          Value: !Sub TargetGroup-WS-${RandomString}

  HttpsListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    DependsOn:
      - Alb
      - AlbCertificate
      - HttpsTargetGroup
    Properties:
      Certificates:
        - CertificateArn: !Ref AlbCertificate
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref HttpsTargetGroup
      LoadBalancerArn: !Ref Alb
      Port: 443
      Protocol: HTTPS

  WsListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    DependsOn:
      - Alb
      - AlbCertificate
      - WsTargetGroup
    Properties:
      Certificates:
        - CertificateArn: !Ref AlbCertificate
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref WsTargetGroup
      LoadBalancerArn: !Ref Alb
      Port: !Ref ProxyServerPort
      Protocol: HTTPS

  Route53Record:
    Type: "AWS::Route53::RecordSet"
    Properties:
      HostedZoneId: !Ref HostedZoneId
      Name: !Join
        - .
        - - !Ref RandomString
          - !Ref HostedZoneName
      Type: A
      AliasTarget:
        DNSName: !GetAtt Alb.DNSName
        EvaluateTargetHealth: false
        HostedZoneId: !GetAtt Alb.CanonicalHostedZoneID

  Service:
    Type: "AWS::ECS::Service"
    DependsOn:
      - HttpsListener
      - WsListener
    Properties:
      Cluster: !Ref ClusterId
      ServiceName: !Sub GameServer-service-${RandomString}
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - !Ref SecurityGroupGameServerTaskId
          Subnets:
            - !Ref PrivateSubnetA
            - !Ref PrivateSubnetB
      DesiredCount: 1
      LaunchType: FARGATE
      TaskDefinition: !Ref TaskDefinitionArn
      HealthCheckGracePeriodSeconds: 300
      LoadBalancers:
        - TargetGroupArn: !Ref HttpsTargetGroup
          ContainerPort: !Ref ProxyServerPort
          ContainerName: !Ref ProxyServerNameContainer
        - TargetGroupArn: !Ref WsTargetGroup
          ContainerPort: !Ref ProxyServerPort
          ContainerName: !Ref ProxyServerNameContainer

Parameters:
  VpcId:
    Type: String
    Default: default
    Description: Project Vpc

  HostedZoneName:
    Type: String
    Default: default
    Description: Hosted zone name

  HostedZoneId:
    Type: String
    Default: default
    Description: Hosted zone ID

  PublicSubnetIdA:
    Type: String
    Default: default
    Description: First subnet of ALB

  PublicSubnetIdB:
    Type: String
    Default: default
    Description: Second subnet of ALB

  SecurityGroupAlbId:
    Type: String
    Default: default
    Description: ALB security group

  RandomString:
    Type: String
    Default: default
    Description: Random string used to get unique resources ID if the CF template is launched several times

  ProxyServerPort:
    Type: Number
    Default: 0
    Description: Port used on proxy server

  ProxyServerNameContainer:
    Type: String
    Default: default
    Description: Name of the proxy container

  ClusterId:
    Type: String
    Default: default
    Description: Id of the cluster

  SecurityGroupGameServerTaskId:
    Type: String
    Default: default
    Description: Ecs task security group

  PrivateSubnetA:
    Type: String
    Default: default
    Description: First private subnet of Ecs task

  PrivateSubnetB:
    Type: String
    Default: default
    Description: Second private subnet of Ecs task

  TaskDefinitionArn:
    Type: String
    Default: default
    Description: Arn of the Ecs task definition
